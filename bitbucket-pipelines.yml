image: atlassian/default-image:4

pipelines:
  default:
    - step:
        name: Build and Push Docker Image
        services:
          - docker
        script:
          # Login to Docker Hub
          - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin

          # Build the Docker image
          - export IMAGE_NAME=clegginabox/pipeline-php84
          - docker build -t $IMAGE_NAME:$BITBUCKET_COMMIT .
          - docker tag $IMAGE_NAME:$BITBUCKET_COMMIT $IMAGE_NAME:latest

          # Push to Docker Hub
          - docker push $IMAGE_NAME:$BITBUCKET_COMMIT
          - docker push $IMAGE_NAME:latest

          # Logout from Docker Hub
          - docker logout

  branches:
    main:
      - step:
          name: Build and Push Docker Image (Main)
          services:
            - docker
          script:
            # Login to Docker Hub
            - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin

            # Build the Docker image
            - export IMAGE_NAME=clegginabox/pipeline-php84
            - docker build -t $IMAGE_NAME:$BITBUCKET_COMMIT .
            - docker tag $IMAGE_NAME:$BITBUCKET_COMMIT $IMAGE_NAME:latest
            - docker tag $IMAGE_NAME:$BITBUCKET_COMMIT $IMAGE_NAME:main

            # Push to Docker Hub
            - docker push $IMAGE_NAME:$BITBUCKET_COMMIT
            - docker push $IMAGE_NAME:latest
            - docker push $IMAGE_NAME:main

            # Logout from Docker Hub
            - docker logout

  tags:
    v*:
      - step:
          name: Build and Push Docker Image (Release)
          services:
            - docker
          script:
            # Login to Docker Hub
            - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin

            # Build the Docker image
            - export IMAGE_NAME=clegginabox/pipeline-php84
            - export TAG_VERSION=${BITBUCKET_TAG#v}
            - docker build -t $IMAGE_NAME:$BITBUCKET_COMMIT .
            - docker tag $IMAGE_NAME:$BITBUCKET_COMMIT $IMAGE_NAME:$TAG_VERSION
            - docker tag $IMAGE_NAME:$BITBUCKET_COMMIT $IMAGE_NAME:latest

            # Push to Docker Hub
            - docker push $IMAGE_NAME:$BITBUCKET_COMMIT
            - docker push $IMAGE_NAME:$TAG_VERSION
            - docker push $IMAGE_NAME:latest

            # Logout from Docker Hub
            - docker logout
